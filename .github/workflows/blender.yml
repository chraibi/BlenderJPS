name: Blender Addon CI

on:
  push:
  pull_request:

jobs:
  addon-smoke-test:
    runs-on: ubuntu-latest
    
    env:
      ADDON_MODULE: "blender_jps"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install system dependencies (headless)
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            ca-certificates curl tar xz-utils \
            libxi6 libxrender1 libxkbcommon0 libsm6 \
            libgl1 libglib2.0-0 libgomp1
      
      - name: Download Blender ${{ matrix.blender_version.version }}
        run: |
          set -euxo pipefail
          TARBALL="blender-${{ matrix.blender_version.version }}-linux-x64.tar.xz"
          URL="https://download.blender.org/release/${{ matrix.blender_version.major_dir }}/${TARBALL}"
          
          echo "Downloading from: $URL"
          curl -fL "$URL" -o "$TARBALL"
          tar -xf "$TARBALL"
          
          BLENDER_DIR="blender-${{ matrix.blender_version.version }}-linux-x64"
          echo "BLENDER_BIN=${GITHUB_WORKSPACE}/${BLENDER_DIR}/blender" >> "$GITHUB_ENV"
          
          "$GITHUB_WORKSPACE/${BLENDER_DIR}/blender" --version
      
      - name: Install dependencies using addon's installation routine
        shell: bash
        run: |
          set -euxo pipefail
          
          # Use the addon's own install_utils module
          cat > /tmp/install_deps.py <<'PY'
          import os
          import sys
          
          addon_dir = os.path.join(os.environ['GITHUB_WORKSPACE'], 'blender_jps')
          if addon_dir not in sys.path:
              sys.path.insert(0, os.path.dirname(addon_dir))
          
          from blender_jps import install_utils
          
          print("=" * 60)
          print(f"Blender Python: {sys.executable}")
          print(f"Python version: {sys.version}")
          print(f"Addon directory: {addon_dir}")
          print("=" * 60)
          
          success, message = install_utils.install_dependencies(addon_dir)
          
          if success:
              print(f"\n✓ {message}")
              
              install_utils.ensure_deps_in_path(addon_dir)
              if install_utils.is_pedpy_installed(addon_dir):
                  import pedpy
                  print(f"✓ pedpy version: {pedpy.__version__}")
              else:
                  print("\n✗ pedpy import failed after installation")
                  sys.exit(1)
          else:
              print(f"\n✗ {message}")
              sys.exit(1)
          PY
          
          "$BLENDER_BIN" --background --python /tmp/install_deps.py
      
      - name: Verify installation matches addon expectations
        shell: bash
        run: |
          set -euxo pipefail
          
          DEPS_DIR="${GITHUB_WORKSPACE}/blender_jps/deps"
          
          if [ ! -d "$DEPS_DIR" ]; then
            echo "✗ deps directory not found at: $DEPS_DIR"
            exit 1
          fi
          
          echo "✓ deps directory exists at: $DEPS_DIR"
          
          if [ ! -d "$DEPS_DIR/pedpy" ]; then
            echo "✗ pedpy package not found in deps directory"
            exit 1
          fi
          
          echo "✓ pedpy package found in deps directory"
          echo ""
          echo "Contents of deps directory:"
          ls -la "$DEPS_DIR"
      
      - name: Run add-on loading test with SQLite
        shell: bash
        run: |
          set -euxo pipefail
          "$BLENDER_BIN" \
            --background \
            --factory-startup \
            --python blender_jps/tests/test_plugin_loading.py \
            -- \
            --addon "${ADDON_MODULE}" \
            --factory-startup \
            --require-module pedpy \
            --require-module shapely \
            --require-operator jupedsim.load_simulation \
            --require-operator jupedsim.select_file \
            --test-dependency-installation \
            --test-sqlite-loading \
            --test-example-file
      
